name: Integration test

on:
  workflow_call:

jobs:
  integration-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup LXD
        uses: canonical/setup-lxd@main
        with:
          channel: 5.12/stable
      - name: Setup operator environment
        uses: charmed-kubernetes/actions-operator@main
        with:
          juju-channel: 3.1/stable
          provider: microk8s
          channel: 1.27-strict/stable
          microk8s-addons: "hostpath-storage dns"
      - name: Enable Multus addon
        continue-on-error: true
        run: |
          sudo microk8s addons repo add community https://github.com/canonical/microk8s-community-addons --reference feat/strict-fix-multus
          sudo microk8s enable multus
          sudo microk8s kubectl -n kube-system rollout status daemonset/kube-multus-ds
          sudo microk8s kubectl auth can-i create network-attachment-definitions
      - name: Run integration tests
        run: tox -vve integration
      - name: Dump debug log
        if: failure()
        run: for m in $(juju models --format json | jq -r '.models[].name' | grep -v "admin/controller"); do juju debug-log -m $m --replay --ms --no-tail; done
        shell: bash
      - name: Dump deployments
        if: failure()
        run: kubectl describe deployments -A
      - name: Dump replicasets
        if: failure()
        run: kubectl describe replicasets -A
      - name: Dump pods and their logs
        if: failure()
        shell: bash
        run: |
          juju status --relations --storage
          kubectl get pods \
              -A \
              -o=jsonpath='{range.items[*]}{.metadata.namespace} {.metadata.name}{"\n"}' \
              --sort-by=.metadata.namespace \
              | grep -v "^\s*$" \
              | while read namespace pod; do \
                   kubectl -n $namespace describe pod $pod; \
                   kubectl -n $namespace logs $pod \
                      --all-containers=true \
                      --tail=100; \
               done
      - name: Archive Tested Charm
        uses: actions/upload-artifact@v3
        if: ${{ github.ref_name == 'main' }}
        with:
          name: tested-charm
          path: .tox/**/sdcore-upf_ubuntu-22.04-amd64.charm
          retention-days: 5
      - name: Archive charmcraft logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: charmcraft-logs
          path: /home/runner/.local/state/charmcraft/log/*.log
      - name: Archive juju crashdump
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: juju-crashdump
          path: juju-crashdump-*.tar.xz
